# DNS

[RFC 1034 DOMAIN NAMES - CONCEPTS AND FACILITIES](https://www.rfc-editor.org/rfc/rfc1034)


## 功能

DNS服务器：分布式存储系统，存储域名到ip地址的映射。

网络客户端程序通过DNS协议查询目标主机的IP地址。

## 工作原理

基于UDP协议的请求应答。


## 报文格式


<table>
    <tr> <td> 16bits 标识 </td> <td> 16bits 标志 </td> </tr>
    <tr> <td> 16bits 问题个数 </td> <td> 16bits 应答资源记录个数 </td> </tr>
    <tr> <td> 16bits 授权资源记录个数 </td> <td> 16bits 额外的资源记录个数 </td> </tr>
    <tr> <td colspan="2"> 查询问题，长度可变 </td> <!-- <td> 16bits 额外的资源记录个数 </td> --> </tr>
    <tr> <td colspan="2"> 应答(资源记录数目可变，长度可变) </td> <!-- <td>  </td> --> </tr>
    <tr> <td colspan="2"> 授权(资源记录数目可变，长度可变) </td> <!-- <td>  </td> --> </tr>
    <tr> <td colspan="2"> 额外信息(资源记录数目可变，长度可变) </td> <!-- <td>  </td> --> </tr>
</table>

- 16bits 标识。由客户端填写，用于匹配一次请求与应答。

- 16bits 标志。通信方式 + 通信状态。具体含义如下：

<table>
    <tr>
        <td> QR </td>
        <td> opcode </td>
        <td> AA </td>
        <td> TC </td>
        <td> RD </td>
        <td> RA </td>
        <td> zero </td>
        <td> rcode </td>
    </tr>
    <tr>
        <td> - </td>
        <td> ---- </td>
        <td> - </td>
        <td> - </td>
        <td> - </td>
        <td> - </td>
        <td> --- </td>
        <td> ---- </td>
    </tr>
</table>

    |标志位  |  含义                                      |
    |:-------|:-------------------------------------------|
    | QR     | 0:request, 1:response                      |
    | opcode | 0:标准查询；1：反向查询；2：服务器状态请求 |
    | AA     | 授权回答（authoritative answer             |
    | TC     | 可截断(truncated)                          |
    | RD     | 期望递归(recursion desired)                | 
    | RA     | 可用递归，表示服务器支持递归查询           |
    | zero   | 必须 = 0                                   |
    | rcode  | 错误码，0正常，3名字差错                   |





## Linux下访问DNS服务器

Linux 下通过配置文件`/etc/resolv.conf`存储域名服务器地址，示例如下：

```
# Generated by Network Manager
nameserver 219.239.26.42
```

Linux 下常用的访问DNS服务器的客户端程序是`host`。

```
~$ host -t A www.baidu.com
www.baidu.com is an alias for www.a.shifen.com.
www.a.shifen.com has address 183.232.231.174
www.a.shifen.com has address 183.232.231.172
```


## DNS请求以太网帧示例

|   二进制数据示例                   | 含义说明                                                                                                 |
|:-----------------------------------|:---------------------------------------------------------------------------------------------------------|
| ---- ---- ----                     | 以太网协议首部。6types 目的MAC                                                                           | 
| ---- ---- ----                     | 6types 源MAC                                                                                             | 
| 0800                               | 2bytes 报文类型：0x0800(IP协议)                                                                          |
| 4500 003b                          | IP报文头。版本号4；首部长度5 * 4 = 20bytes = 固定长度，即无可选字段；总长度0x3b = 59 - 20 = 39bytes      |
| d710 0000                          | 2bytes 标识，分片时相同用于组包; 3bits 标志，R、DF(是否分片)、MF(是否有更多分片) ; 13bits 片偏移         |
| 4011 cabd                          | 1bytes TTL:0x40; 1bytes协议类型: 0x11 = 17(UDP) ; 2bytes首部校验和: 0xcabd                               |
| ---- ----                          | IP头，源地址                                                                                             | 
| ---- ----                          | IP头，目的地址                                                                                           | 
| 9c43 0035                          | UDP协议首部。2bytes源端口0x9c43 = 40003，2bytes目的端口0x0035 = 53                                       |      
| 0027 d91c                          | 2bytes总长度0x27 = 39bytes, 2bytes校验和: 0xd91c                                                         | 
| bf3d 0100                          | DNS协议头。2bytes标识 + 2bytes标志(1b QR; 4b op; 1b AA; 1b TC; 1b RD; 1b RA; 3b zero; 4b rcode           | 
| 0001 0000                          | 问题数: 1，资源数: 0                                                                                     | 
| 0000 0000                          | 授权资源数: 0，额外资源数: 0                                                                             | 
| 0377 7777 0562 6169 6475 0363 6f6d | www.baidu.com                                                                                            | 
| 00                                 | 查询名字结束标志: '\0'。查询名为变长部分，以0结尾                                                        |                                                                      
| 0001 0001                          | 2bytes查询类型, 1: IP地址。2bytes查询类，1：互联网地址                                                   |               

